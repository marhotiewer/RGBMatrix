#include "hwlib.hpp"

void shift(hwlib::target::pin_out& clk) {
	clk.write(1);
	hwlib::wait_us(10);
	clk.write(0);
	hwlib::wait_us(10);
}

void shiftOut(hwlib::target::pin_out& din, hwlib::target::pin_out& clk, char data) {
	din.write(data&1);
	shift(clk);
	
	for(int i = 0; i < 7; i++) {
		din.write((data>>=1)&1);
		shift(clk);
	}
}

void store(hwlib::target::pin_out& lat) {
	lat.write(1);
	hwlib::wait_us(10);
	lat.write(0);
	hwlib::wait_us(10);
}

int main(void) {
	hwlib::target::pin_out lat(hwlib::target::pins::d51);
	hwlib::target::pin_out clk(hwlib::target::pins::d49);
	hwlib::target::pin_out din(hwlib::target::pins::d53);

	lat.write(0);
	clk.write(0);
	din.write(0);

	//char E[8] = 	 	{0x3C,0x20,0x20,0x3C,0x20,0x20,0x20,0x3C};
	//char L[8] = 	 	{0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x3E};
	//char C[8] = 	 	{0x1C,0x20,0x20,0x20,0x20,0x20,0x20,0x1C};
	//char T[8] = 	 	{0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x10};
	//char R[8] = 	 	{0x38,0x24,0x24,0x28,0x30,0x28,0x24,0x24};
	//char O[8] = 	 	{0x1C,0x22,0x22,0x22,0x22,0x22,0x22,0x1C};
	//char N[8] = 	 	{0x42,0x62,0x52,0x52,0x4A,0x46,0x46,0x42};
	//char I[8] = 	 	{0x38,0x10,0x10,0x10,0x10,0x10,0x10,0x38};
	//char S[8] = 	 	{0x1C,0x20,0x20,0x10,0x08,0x04,0x04,0x38};
	//char H[8] = 	 	{0x22,0x22,0x22,0x3E,0x22,0x22,0x22,0x22};
	//char U[8] = 	 	{0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x1C};
	//char B[8] =  	    {0x38,0x24,0x24,0x38,0x38,0x24,0x24,0x38};
	char smile[8] =   {0x3C,0x42,0xA5,0x81,0xA5,0x99,0x42,0x3C};
	//char neutral[8] = {0x3C,0x42,0xA5,0x81,0xBD,0x81,0x42,0x3C};
	//char frown[8] =   {0x3C,0x42,0xA5,0x81,0x99,0xA5,0x42,0x3C};

	for(;;) {
		for(int i = 0; i < 8; i++) {
			shiftOut(din, clk, ~smile[i]);
			shiftOut(din, clk, 128 >> i);
			store(lat);
		}
	}
}
